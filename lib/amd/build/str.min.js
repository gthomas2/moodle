define(["jquery","core/ajax","core/localstorage"],function(a,b,c){var d={};return{get_string:function(a,b,c,d){var e=this.get_strings([{key:a,component:b,param:c,lang:d}]);return e.then(function(a){return a[0]})},request_key:function(a){return"core_str/"+a.key+"/"+a.component+"/"+a.lang},get_strings:function(e){var f,g=a.Deferred(),h=[],i=0,j=!1,k=this;for(i=0;i<e.length;i++)if(f=e[i],"undefined"==typeof f.lang&&(f.lang=a("html").attr("lang").replace("-","_")),"undefined"==typeof M.str[f.component]||"undefined"==typeof M.str[f.component][f.key]){var l=c.get(k.request_key(f));l?("undefined"==typeof M.str[f.component]&&(M.str[f.component]=[]),M.str[f.component][f.key]=l):j=!0}if(j){var m=[],n=[];for(i=0;i<e.length;i++)f=e[i],n.push(k.request_key(f)),m.push({methodname:"core_get_string",args:{stringid:f.key,component:f.component,lang:f.lang,stringparams:[]}});var o=n.join("~");if(o in d)return d[o];d[o]=g.promise();var p=b.call(m,!0,!1);a.when.apply(null,p).done(function(){var a=0;for(a=0;a<arguments.length;a++)f=e[a],"undefined"==typeof M.str[f.component]&&(M.str[f.component]=[]),M.str[f.component][f.key]=arguments[a],c.set(k.request_key(f),arguments[a]),h[a]=M.util.get_string(f.key,f.component,f.param).trim();g.resolve(h)}).fail(function(a){g.reject(a)}).always(function(){delete d[o]})}else{for(i=0;i<e.length;i++)f=e[i],h[i]=M.util.get_string(f.key,f.component,f.param);g.resolve(h)}return g.promise()}}});